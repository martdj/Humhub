name: humhub

# ==================================================
# NETWORKS
# ==================================================
networks:
  proxy:
    driver: bridge
  app-net:
    driver: bridge

# ==================================================
# VOLUMES (host bind mounts under /local/humhub/data)
# ==================================================
volumes:
  db-data:
    driver: local
    driver_opts: { type: none, o: bind, device: /local/humhub/data/db-data }

  config:
    driver: local
    driver_opts: { type: none, o: bind, device: /local/humhub/data/humhub/config }

  uploads:
    driver: local
    driver_opts: { type: none, o: bind, device: /local/humhub/data/humhub/uploads }

  modules:
    driver: local
    driver_opts: { type: none, o: bind, device: /local/humhub/data/humhub/modules }

  logs:
    driver: local
    driver_opts: { type: none, o: bind, device: /local/humhub/data/humhub/logs }

  themes:
    driver: local
    driver_opts: { type: none, o: bind, device: /local/humhub/data/humhub/themes }

  onlyoffice_data:
    driver: local
    driver_opts: { type: none, o: bind, device: /local/humhub/data/onlyoffice/data }

  onlyoffice_log:
    driver: local
    driver_opts: { type: none, o: bind, device: /local/humhub/data/onlyoffice/log }

  backups:
    driver: local
    driver_opts: { type: none, o: bind, device: /local/humhub/data/backups }

  traefik_letsencrypt:
    driver: local
    driver_opts: { type: none, o: bind, device: /local/humhub/data/traefik/letsencrypt }

  redis_data:
    driver: local
    driver_opts: { type: none, o: bind, device: /local/humhub/data/redis }

# ==================================================
# SERVICES
# ==================================================
services:

  # ------------------------------------------------
  # REVERSE PROXY (Traefik 3.6)
  # ------------------------------------------------
  traefik:
    image: traefik:v3.6
    restart: unless-stopped
    network_mode: host
    environment:
      - TZ=${TZ}
    command:
      # Providers
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false

      # EntryPoints
      - --entrypoints.web.address=[::]:80
      - --entrypoints.websecure.address=[::]:443

      # ACME (Let's Encrypt) - Traefik 3 style
      - --certificatesresolvers.letsencrypt.acme.email=${LE_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpChallenge.entryPoint=web
      # Staging toggle is handled by prepare_system.sh (adds/removes caserver flag)
      # # - --certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory

      # Logging
      - --accesslog=true
      - --log.level=INFO

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt

  # ------------------------------------------------
  # DATABASE (MariaDB)
  # ------------------------------------------------
  mariadb:
    image: mariadb:11.4
    restart: unless-stopped
    command: ["--character-set-server=utf8mb4", "--collation-server=utf8mb4_unicode_ci"]
    environment:
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_DATABASE=${MARIADB_DATABASE}
      - MARIADB_USER=${MARIADB_USER}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD}
      - TZ=${TZ}
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - app-net

  # ------------------------------------------------
  # HUMHUB (Main web application)
  # ------------------------------------------------
  humhub:
    image: mriedmann/humhub:${HUMHUB_VERSION}
    restart: unless-stopped
    depends_on:
      - mariadb
      - redis
    environment:
      - TZ=${TZ}
      - HUMHUB_PROTO=https
      - HUMHUB_HOST=${HUMHUB_HOST}
      - HUMHUB_BASE_URL=${HUMHUB_BASE_URL}

      # Database
      - HUMHUB_DB_HOST=mariadb
      - HUMHUB_DB_PORT=3306
      - HUMHUB_DB_NAME=${MARIADB_DATABASE}
      - HUMHUB_DB_USER=${MARIADB_USER}
      - HUMHUB_DB_PASSWORD=${MARIADB_PASSWORD}

      # Redis
      - HUMHUB_REDIS_HOSTNAME=redis
      - HUMHUB_REDIS_PORT=6379
      - HUMHUB_REDIS_PASSWORD=${REDIS_PASSWORD}
      - HUMHUB_CACHE_CLASS=yii\redis\Cache
      - HUMHUB_CACHE_EXPIRE_TIME=3600
      - HUMHUB_QUEUE_CLASS=humhub\modules\queue\driver\Redis

      # Auto-install
      - HUMHUB_AUTO_INSTALL=1
      - HUMHUB_DEBUG=0

      # Nginx/PHP settings
      - NGINX_CLIENT_MAX_BODY_SIZE=${NGINX_CLIENT_MAX_BODY_SIZE}
      - NGINX_KEEPALIVE_TIMEOUT=${NGINX_KEEPALIVE_TIMEOUT}

      # Admin initialization
      - HUMHUB_ADMIN_USERNAME=${HUMHUB_ADMIN_USERNAME}
      - HUMHUB_ADMIN_EMAIL=${HUMHUB_ADMIN_EMAIL}
      - HUMHUB_ADMIN_PASSWORD=${HUMHUB_ADMIN_PASSWORD}

    volumes:
      - config:/var/www/localhost/htdocs/protected/config
      - uploads:/var/www/localhost/htdocs/uploads
      - modules:/var/www/localhost/htdocs/protected/modules
      - logs:/var/www/localhost/htdocs/protected/runtime/logs
      # Search index is not persisted
      - themes:/var/www/localhost/htdocs/themes
    networks:
      - app-net
      - proxy

    labels:
      - traefik.enable=true
      - traefik.http.routers.humhub.rule=Host(`${HUMHUB_HOST}`)
      - traefik.http.routers.humhub.entrypoints=websecure
      - traefik.http.routers.humhub.tls.certresolver=letsencrypt
      - traefik.http.routers.humhub.middlewares=security-headers,compress
      - traefik.http.services.humhub.loadbalancer.server.port=80

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ------------------------------------------------
  # HUMHUB CRON (Queue + Cron runner)
  # ------------------------------------------------
  humhub-cron:
    image: mriedmann/humhub:${HUMHUB_VERSION}
    restart: unless-stopped
    depends_on:
      - humhub
    command: ["sh", "-c",
      "while true; do \
        php /var/www/localhost/htdocs/protected/yii queue/run && \
        php /var/www/localhost/htdocs/protected/yii cron/run; \
      sleep 60; done"
    ]
    environment:
      - TZ=${TZ}
      - HUMHUB_PROTO=https
      - HUMHUB_HOST=${HUMHUB_HOST}
      - HUMHUB_BASE_URL=${HUMHUB_BASE_URL}

      - HUMHUB_DB_HOST=mariadb
      - HUMHUB_DB_PORT=3306
      - HUMHUB_DB_NAME=${MARIADB_DATABASE}
      - HUMHUB_DB_USER=${MARIADB_USER}
      - HUMHUB_DB_PASSWORD=${MARIADB_PASSWORD}

      - HUMHUB_REDIS_HOSTNAME=redis
      - HUMHUB_REDIS_PORT=6379
      - HUMHUB_REDIS_PASSWORD=${REDIS_PASSWORD}

      - HUMHUB_AUTO_INSTALL=1
      - HUMHUB_DEBUG=0

    volumes:
      - config:/var/www/localhost/htdocs/protected/config
      - uploads:/var/www/localhost/htdocs/uploads
      - modules:/var/www/localhost/htdocs/protected/modules
      - logs:/var/www/localhost/htdocs/protected/runtime/logs
      - themes:/var/www/localhost/htdocs/themes
    networks:
      - app-net

# ------------------------------------------------
  # ONLYOFFICE Document Server
  # ------------------------------------------------
  onlyoffice:
    image: onlyoffice/documentserver:${ONLYOFFICE_VERSION}
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - JWT_ENABLED=true
      - JWT_SECRET=${ONLYOFFICE_JWT_SECRET}
      - USE_UNAUTHORIZED_STORAGE=true  # good for testing, but replace later
      
      # Allow HumHub (frontend) as trusted storage/origin
      - DS_STORAGE_ALLOWED_STORAGE_ORIGINS=https://${HUMHUB_HOST}

      # Make URL awareness explicit (helps with reverse proxy/HTTPS awareness)
      - DS_GENERAL_SERVER_URL=https://${ONLYOFFICE_HOST}
      - DS_GENERAL_USE_FORWARDED_HEADERS=true

    volumes:
      - onlyoffice_data:/var/lib/onlyoffice
      - onlyoffice_log:/var/log/onlyoffice
    networks:
      - proxy

    labels:
      - traefik.enable=true

      # HTTP → HTTPS redirect
      - traefik.http.routers.onlyoffice-http.rule=Host(`${ONLYOFFICE_HOST}`)
      - traefik.http.routers.onlyoffice-http.entrypoints=web
      - traefik.http.routers.onlyoffice-http.middlewares=redirect-to-https
      - traefik.http.routers.onlyoffice-http.service=onlyoffice

      # HTTPS router
      - traefik.http.routers.onlyoffice.rule=Host(`${ONLYOFFICE_HOST}`)
      - traefik.http.routers.onlyoffice.entrypoints=websecure
      - traefik.http.routers.onlyoffice.tls.certresolver=letsencrypt
      - traefik.http.routers.onlyoffice.service=onlyoffice
      - traefik.http.routers.onlyoffice.middlewares=onlyoffice-chain

      # service port
      - traefik.http.services.onlyoffice.loadbalancer.server.port=80

      # middleware chain
      - traefik.http.middlewares.onlyoffice-chain.chain.middlewares=onlyoffice-headers,compress

      # REQUIRED headers for OnlyOffice
#      - traefik.http.middlewares.onlyoffice-headers.headers.customrequestheaders.X-Forwarded-Proto=https
#      - traefik.http.middlewares.onlyoffice-headers.headers.customrequestheaders.X-Forwarded-Host=${ONLYOFFICE_HOST}
#      - traefik.http.middlewares.onlyoffice-headers.headers.customrequestheaders.X-Forwarded-For=127.0.0.1

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/healthcheck || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10

  # ------------------------------------------------
  # SMTP Relay
  # ------------------------------------------------
  smtp:
    image: boky/postfix:latest
    restart: unless-stopped
    environment:
      - RELAYHOST=${SMTP_RELAY_HOST}
      - RELAYHOST_PORT=${SMTP_RELAY_PORT}
      - RELAYHOST_USERNAME=${SMTP_RELAY_USER}
      - RELAYHOST_PASSWORD=${SMTP_RELAY_PASSWORD}
      - TLS_POLICY=encrypt
      - SERVER_HOSTNAME=${SMTP_HELO_NAME}
      - ALLOWED_SENDER_DOMAINS=martdj.nl
      - TZ=${TZ}
    networks:
      - app-net

  # ------------------------------------------------
  # Automated Backups
  # ------------------------------------------------
  backup:
    image: fradelg/mysql-cron-backup:latest
    restart: unless-stopped
    depends_on:
      - mariadb
    environment:
      - MYSQL_HOST=mariadb
      - MYSQL_USER=${MARIADB_USER}
      - MYSQL_PASS=${MARIADB_PASSWORD}
      - MYSQL_DB=${MARIADB_DATABASE}
      - CRON_TIME=${BACKUP_SCHEDULE}
      - MYSQLDUMP_OPTS=--single-transaction --routines --events
      - TZ=${TZ}
    volumes:
      - backups:/backup
    networks:
      - app-net

  # ------------------------------------------------
  # REDIS
  # ------------------------------------------------
  redis:
    image: redis:7.0-alpine
    restart: unless-stopped
    command:
      - redis-server
      - --requirepass
      - ${REDIS_PASSWORD}
      - --appendonly
      - "yes"
    volumes:
      - redis_data:/data
    networks:
      - app-net
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------------------------------
  # Traefik Middlewares (static providers)
  # ------------------------------------------------
  traefik-middlewares:
    image: traefik:v3.6
    labels:
      - traefik.enable=true

      # Redirect: HTTP → HTTPS
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https

      # Compression
      - traefik.http.middlewares.compress.compress=true

      # Security headers
      - traefik.http.middlewares.security-headers.headers.stsSeconds=31536000
      - traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true
      - traefik.http.middlewares.security-headers.headers.stsPreload=true
      - traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true
      - traefik.http.middlewares.security-headers.headers.browserXssFilter=true
      - traefik.http.middlewares.security-headers.headers.referrerPolicy=no-referrer-when-downgrade
      - traefik.http.middlewares.security-headers.headers.frameDeny=true

    networks:
      - proxy
