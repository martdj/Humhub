#!/bin/bash
set -e

HUMHUB_USER="humhub"
HUMHUB_DIR="/local/humhub"
DATA_DIR="$HUMHUB_DIR/data"

ENV_URL="https://raw.githubusercontent.com/martdj/Humhub/refs/heads/main/.env"
COMPOSE_URL="https://raw.githubusercontent.com/martdj/Humhub/refs/heads/main/docker-compose.yml"

# === Vereisten ===
dnf install -y curl yum-utils firewalld

# === Docker check & installation ===
if ! command -v docker &>/dev/null; then
    echo "Docker not found, install..."
    yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
    dnf install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

    systemctl start docker
    systemctl enable docker
else
    echo "Docker has already been installed"
fi

# === SELinux (if active) ===
if command -v getenforce &>/dev/null && [ "$(getenforce)" != "Disabled" ]; then
    setsebool -P container_manage_cgroup on
fi

# === User ===
if ! id "$HUMHUB_USER" &>/dev/null; then
    useradd "$HUMHUB_USER"
fi

# === Directory structure ===
mkdir -p \
  $DATA_DIR/db-data \
  $DATA_DIR/humhub/{config,uploads,modules,logs,searchdb,themes} \
  $DATA_DIR/onlyoffice/{data,log} \
  $DATA_DIR/backups \
  $DATA_DIR/traefik/letsencrypt

touch $DATA_DIR/traefik/letsencrypt/acme.json

# === Safety-check existing data ===
if [ -d "$DATA_DIR/db-data" ] && [ "$(ls -A $DATA_DIR/db-data)" ]; then
    echo "⚠ WARNING: db-data directory not empty"
fi

# === Config files download ===
cd "$HUMHUB_DIR"

if [ ! -f .env ]; then
    curl -fsSL "$ENV_URL" -o .env
fi

if [ ! -f docker-compose.yml ]; then
    curl -fsSL "$COMPOSE_URL" -o docker-compose.yml
fi

# Validation
[ -s .env ] || { echo "❌ .env is leeg"; exit 1; }
[ -s docker-compose.yml ] || { echo "❌ docker-compose.yml is leeg"; exit 1; }

# === Rights ===
chown -R $HUMHUB_USER:$HUMHUB_USER "$HUMHUB_DIR"
chmod 600 $DATA_DIR/traefik/letsencrypt/acme.json
chmod -R 755 "$DATA_DIR"

# === Firewall ===
systemctl enable --now firewalld
firewall-cmd --add-service=http --permanent
firewall-cmd --add-service=https --permanent
firewall-cmd --reload

# === Pull Docker images (no start) ===
docker compose pull

echo "✔ HumHub host provisioning completed (images pulled, stack not started)"
